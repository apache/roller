#**
 * Weblog entries, comments, and related links.
 * @author Lance Lavandowska (conversion to Velocimacros)
 * @author David M Johnson (comment macros)
 *#

#**
 * Print status/error message if exists.
 * Note: "error" and "status" styles should be moved out into
 * invididual Themes' theme.css files.
 **#
#macro( showStatusMessage )
    #if( $errorMessage )
        <span class="error">$errorMessage</span>
    #end
    #if( $statusMessage )
        <span class="status">$statusMessage</span>
    #end
#end

#**
 * Set the META tag for ContentLanguage.  We do this rather than
 * setting the Response header because the header does not get
 * cached.  So in order to maintain the ContentType we must present
 * it inside the rendered page itself.
**#
#macro( showContentLanguage $lang )
    <meta http-equiv="Content-Language" content="$lang">
#end

#**
 * Use this macro in your day template if you want to override
 * entry rendering in both your HTML and RSS weblog output by defining
 * a page template named _entry.
 *
 * <p>It is no longer necessary to use a page template named _entry
 * if you want to override entry rendering in both your
 * HTML and RSS weblog output (for support of PagePlugins).
 * However, backwards compatibility for such use is still included,
 * or if you have some other need to override entry rendering.
 * The _entry page is now loaded by ContextLoader as $entryPage.</p>
 *#
#macro( showEntryText $entry )
   #if(  $entryPage )
      #parse($entryPage.id)
   #else
      #if ( $entry.plugins )
         #set( $entryText = $pageHelper.renderPlugins( $entry ) )
      #else
         #set( $entryText = $entry.text )
      #end
      #if( $entryLength == -1 )
        $utilities.textToCDATA($entryText)
      #else
        #set( $entryText = $utilities.textToCDATA($utilities.removeHTML($entryText)) )
        $stringUtils.left( $entryText, $entryLength )... [$entryText.length() characters]
      #end
   #end
#end

#**
 * Use this macro in your day template if you want to override
 * entry rendering in both your HTML and RSS weblog output by defining
 * a page template named _desc.
 *
 * <p>It is no longer necessary to use a page template named _desc
 * if you want to override entry rendering in both your
 * HTML and RSS weblog output (for support of PagePlugins).
 * However, backwards compatibility for such use is still included,
 * or if you have some other need to override entry rendering.
 * The _desc page is now loaded by ContextLoader as $descPage.</p>
 *#
#macro( showEntryDescription $entry )
   #if(  $descPage )
      #parse($descPage.id)
   #else
      #if ( $entry.plugins )
         #set( $entryText = $pageHelper.renderPlugins( $entry ) )
      #else
         #set( $entryText = $entry.text )
      #end
      #if( $entryLength == -1 )
        $utilities.textToXML($entryText)
      #else
        #set( $entryText = $stringUtils.left( $entryText, $entryLength ) )
        #set( $entryText = $utilities.textToXML($utilities.removeHTML($entryText)) )
        $entryText... [$entryText.length() characters]
      #end
   #end
#end

#**
 * Display Permalink for Date.
 * @param day Date object that specifies day (type java.util.Date).
 *#
#macro( showDayPermalink $day )
    <a href="$baseURL/page/$userName/#formatDate($plainFormat $day )"><img
        class="daypermalink"
        src="$ctxPath/images/permalink.gif"
        title="$text.get( "macro.weblog.daypermalink.title" )"
        alt="#formatDate( $plainFormat $day )" /></a>
#end

#**
 * Display the default Date.toString for date using the 'macro.weblog.date.toStringFormat'
 * format as defined in the resource bundle.
 * @param toStringFormat Format string (see java.text.SimpleDateFormat).
 * @param day Date object that specifies day (type java.util.Date).
 *#
#macro( showEntryDate $day )
    #set( $format=$text.get("macro.weblog.date.toStringFormat") )
    #formatDate( $format $day )
    ##formatDate( $toStringFormat $day )
#end

#**
 * Display the timestamp for the $day using the 'macro.weblog.date.timestampFormat'
 * format as defined in the resource bundle.
 *
 * @param timestampFormat Format string (see java.text.SimpleDateFormat).
 * @param day Date object that specifies day (type java.util.Date).
 *#
#macro( showTimestamp $day )
    #set( $format = $text.get("macro.weblog.date.timestampFormat") )
    #formatDate( $format $day )
    ##formatDate( $timestampFormat $day )
#end

#**
 * Display the Permalink for a weblog entry.
 * @param entry WeblogEntry object.
 *#
#macro( showEntryPermalink $entry )
    <a href="$baseURL$entry.permaLink"
        title="$text.get( "macro.weblog.entrypermalink.title" )"
        class="entrypermalink">Permalink</a>
    #if ($pageHelper.isUserAuthorizedToEdit())
        [<a href="$pageHelper.getEntryEditUrl($entry)">$text.get( "macro.weblog.entrypermalink.edit" )</a>]
    #end
#end

#**
 * Display the Trackback URL for a weblog entry.
 * @param entry WeblogEntry object.
 *#
#macro( showTrackbackURL $entry )
$absBaseURL/trackback/$userName/$page.link/$utilities.encode($entry.anchor)#end

#**
 * Display search form for searching a weblog.  This is only a form, no div
 * or anything around it.
 *#
#macro( showSearchForm )
    <form id="searchForm" method="get" action="$ctxPath/search/$userName"
        style="margin: 0; padding: 0" onsubmit="return validateSearch(this)">
        <p>
          <input type="text" id="q" name="q" size="20"
              maxlength="255" value="#if($term)$term#end" />
          #set( $cats = $pageModel.getWeblogCategories("nil") )
          <select name="c">
          <option value="">- In Category -</option>
          #foreach( $cat in $cats )
              <option #if($cat.name == $req.getParameter('c'))selected="selected"#end>$cat.name</option>
          #end
          </select>
          <input type="submit" value="$text.get( "macro.weblog.searchbutton" )" />
        </p>
    </form>
    <script type="text/javascript">
        function validateSearch(form) {
            if (form.q.value == "") {
                alert("$text.get( "macro.weblog.searchalert" )");
                form.q.focus();
                return false;
            }
            return true;
        }
    </script>
#end

#**
 * Display search again form
 *#
#macro( showSearchAgainForm )
    <div id="searchAgain">
        $text.get( "macro.weblog.searchdictionary", [$term, $term, $term] )

        $text.get( "macro.weblog.searchhits", [$hits])

        <form method="get" action="$ctxPath/search/$userName"
            style="margin: 5px">
            <input type="text" id="q" name="q" size="31"
                maxlength="255" value="$term"
                style="padding-left: 1px" />
            #set( $cats = $pageModel.getWeblogCategories("nil") )
            <select name="c">
            <option value="">- Restrict By Category -</option>
            #foreach( $cat in $cats )
              <option #if($cat.name == $req.getParameter('c'))selected="selected"#end>$cat.name</option>
            #end
            </select>
            <input type="submit" value="$text.get( "macro.weblog.searchagain" )" />
        </form>

        $text.get( "macro.weblog.searchgoogle", [$term, $absBaseURL, $ctxPath, $userName] )
    </div>
    <script type="text/javascript"
        src="$ctxPath/theme/scripts/searchhi.js"></script>
#end

#**
 * Displays header like "1 - 10 of 20 found.".
**#
#macro( showSearchSummary )
    #set( $min = $offset + 1 )
    #set( $max = $offset + $limit )
    #if( $max > $hits )#set( $max = $hits )#end
    <h3>
        $min - $max of $hits found.
    </h3>
#end

#**
 * Display list of search result pages (for pagination).
**#
#macro( showSearchPager )
    <h3 style="text-align:center;">
    #set( $numPages = $hits / $limit )
    #set( $remainder = $hits % $limit )
    #if( $remainder > 0 )#set( $numPages = $numPages + 1 )#end
    #if( $numPages > 1 )
        #foreach( $pageNum in [1..$numPages] )
            #set( $i = $pageNum - 1 )
            #set( $start = $limit * $i )
            <a href="?q=${utilities.encode($term)}&${USERNAME_KEY}=$!{username}&n=${limit}&o=${start}"
               >$pageNum</a>#if( $pageNum != $numPages) | #end
        #end
    #end
    </h3>
#end

#**
 * Shows weblog entries from specified category 
 * using specified page as a "day template" for the display of each day.
 * If a specific weblog entry is specified by the current request (using
 * the anchor tag), then shows the only the specified entry (using the day
 * template) along with the comments associated with that entry.
 *
 * @param pageName   Page name of page to serve as day template.
 * @param maxEntries Maximum number of entries to be shown.
 * @param category   Only display weblog entries from this category.
 *#
#macro( showWeblogEntriesInCategory $pageName $maxEntries $category )
    #if ( $pageModel.getWeblogEntry() )
        #set( $entry = $pageModel.getWeblogEntry() )
    #end
    #set( $dayTemplateId = $pageModel.getPageIdByName($pageName) )
    #if ( !$dayTemplateId ) ## if no page name, try Preview space
        #set ( $dayTemplateId = $pageName )
    #end
    #if( $entry )
        #set( $day = $entry.pubTime )
        #set( $entries = [ $entry ] )
        #parse( $dayTemplateId )
        <div class="trackbackUrl">
           $text.get( "macro.weblog.trackback" ) #showTrackbackURL($entry)
        </div>
        #showComments($entry)
        #if($website.allowComments && $entry.commentsStillAllowed)
            #showCommentForm($entry)
        #else
            $text.get("comments.disabled")
        #end
    #else
        #if( $searchResults )
            #set( $map = $searchResults )
            #showSearchAgainForm()
            #showSearchSummary()
        #else
            #set( $map = $pageModel.getRecentWeblogEntries($maxEntries, $category) )
        #end
        #foreach( $day in $map.keySet() )
            #set( $entries = $map.get($day) )
            #parse( $dayTemplateId )
        #end
        #if( $searchResults )
            #showSearchPager()
        #end
    #end
#end

#**
 * Shows weblog entries using specified page as a "day template" for
 * the display of each day. If a specific weblog entry is specified
 * by the current request (using the anchor tag), then shows the only
 * the specified entry (using the day template) along with the comments
 * associated with that entry.
 *
 * @param pageName Page name of page to serve as day template.
 * @param maxEntries Maximum number of entries to be shown.
 *#
#macro( showWeblogEntries $pageName $maxEntries )
#showWeblogEntriesInCategory($pageName $maxEntries 'nil')
#end

#**
 * Show the last $maxEntries number of weblogentry titles in a category,
 * as links to the individual posts.  Names of fields
 * must be different than in showWeblogEntries (those
 * values take precedence for some reason).
**#
#macro( showRecentEntriesInCategory $entryCount $catPath )
   #set( $xmap = $pageModel.getRecentWeblogEntries($entryCount,$catPath) )
   <ul class="recentposts">
   #foreach( $day in $xmap.keySet() )
       #set( $recentEntries = $xmap.get($day) )
       #foreach ($var in $recentEntries)
           <li class="recentposts"><a href="$baseURL/page/$userName/?entry=$utilities.encode($var.anchor)">$var.title</a></li>
       #end
   #end
   </ul>
#end

#**
 * Show the last $maxEntries number of weblogentry titles,
 * as links to the individual posts.  Names of fields
 * must be different than in showWeblogEntries (those
 * values take precedence for some reason).
**#
#macro( showRecentEntries $entryCount )
#showRecentEntriesInCategory($entryCount "nil")
#end

#**
 * Show the last $maxEntries number of weblogentry titles, as links to
 * entry links.  Names of fields must be different than in showWeblogEntries
 * (those values take precedence for some reason).
**#
#macro( showRecentEntryLinksInCategory $numEntries $cat)
   #set( $xmap = $pageModel.getRecentWeblogEntries($numEntries, $cat) )
   <ul class="linkblog">
   #foreach( $day in $xmap.keySet() )
       #set( $recentEntries = $xmap.get($day) )
       #foreach ($var in $recentEntries)
           <li class="linkblog">
           #if ($var.link)
              <a href="$var.link" title="$utilities.removeAndEscapeHTML($var.text)">$var.title</a>
           #else
              $var.title
           #end
           #if ($pageHelper.isUserAuthorizedToEdit())
              &nbsp;[<a href="$pageHelper.getEntryEditUrl($var)">$text.get( "macro.weblog.editentry" )</a>]
           #end
           </li>
       #end
   #end
   </ul>
#end

#**
 * Show the last $maxEntries number of weblogentry titles, as links to
 * entry links.  Names of fields must be different than in showWeblogEntries
 * (those values take precedence for some reason).
**#
#macro( showRecentEntryLinks $numEntries )
#showRecentEntryLinksInCategory($numEntries "nil")
#end

#**
 * Display language form for selection a different language.  This is only a form, no div
 * or anything around it.
 *#
#macro( showLanguageForm )
    ## first check for errors during possible previous langauge change
    #if ($languageError)
        <p>$languageError</p>
    #end

    #set( $locales = $pageHelper.getSupportedLanguages() )
    #if ($locales)
       #foreach($locale in $locales)
          <a class="imageLink" href="$ctxPath/language${pageHelper.getPathInfo()}?language=${locale}">
             <img src="$ctxPath/images/flag_${locale.toString().toLowerCase()}.gif" alt="${locale.getDisplayLanguage()}" />
          </a>
          <br />
       #end
    #else
        <p>$text.get("macro.weblog.nolanguages")</p>
    #end
#end

#**
 * Display links to Previous and/or Next chronological Entry.  Also
 * display link to "main" page if either is present.
**#
#macro( showNextPreviousLinks )
    #set( $npcat = 'nil' )
    #set( $catLink = "" )
    #if ( $catPath && $catPath != "") 
        #set( $npcat = $catPath )
        #set( $catLink = "?catname=$catPath" ) 
    #end
    <div class="next-previous">
    #if ($pageModel.previousEntry)
        #showPrevEntryLink($npcat) |
    #end
    #if ( $pageModel.previousEntry || $pageModel.nextEntry)
        <a href="$ctxPath/page/$userName/$page.link$catLink">$page.name</a>
    #end
    #if ($pageModel.nextEntry)
        | #showNextEntryLink($npcat)
    #end
    </div>
#end

#**
 * Display link to chronologically previous entry in the
 * same category (if specified).
**#
#macro( showPrevEntryLink $category)
    <span id="previousEntry">
    #if( $pageModel.previousEntry )
        #set( $prev = $pageModel.previousEntry )
        #set( $prevURL = "$baseURL/page/${prev.website.user.userName}/#formatDate($plainFormat ${prev.pubTime})" )
        #if ( $category != 'nil' ) #set( $prevURL = "$prevURL?catname=$category" )#end
        <a href="$prevURL" title="Previous Entries"
            >&laquo; $utilities.truncateNicely($prev.title, 30, 30, "...")</a>
    #end
    </span>
#end

#**
 * Display link to chronologically next entry in the
 * same category (if specified).
**#
#macro( showNextEntryLink $category)
    <span id="nextEntry">
    #if( $pageModel.nextEntry )
        #set( $next = $pageModel.nextEntry )
        #set( $nextURL = "$baseURL/page/${next.website.user.userName}/#formatDate($plainFormat ${next.pubTime})" )
        #if ( $category != 'nil' ) #set( $nextURL = "$nextURL?catname=$category" )#end 
        <a href="$nextURL" title="Next Entries"
            >$utilities.truncateNicely($next.title, 30, 30, "...") &raquo;</a>
    #end
    </span>
#end

#**
 * Method to retrieve a full encoded anchor tag for a WeblogEntry.
**#
#macro( showAnchorTag $entry )
    <a name="$utilities.encode($entry.anchor)" id="$utilities.encode($entry.anchor)"></a>
#end