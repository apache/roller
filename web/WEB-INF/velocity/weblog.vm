
#** Set of essential macros needed in Roller velocity templates.

Implemented:
      #showWeblogEntriesPager($pager)
      #showWeblogEntryComments($entry)
      #showWeblogEntryCommentForm($entry)
      #showCategoryLinksList()
      #showWeblogEntryLinksList()

To be implemented:
      #showBookmarkList()
      #showPageLinksList()
      #showTrackbackAutodiscoveryRDF()
      #showAutodiscoveryLinks()
      #includePage()
      #showSearchForm()
      #showSearchAgainForm()
      #showSearchSummary()
      #showSearchPager()
*#


#** 
Shows weblog entries pager via default day template 
*#
#macro(showWeblogEntriesPager $pager)
    #set($dayPage = $model.weblog.findPageIdByName("_day"))
    #set($map = $pager.getEntries())
    #foreach($day in $map.keySet())
        #set($entries = $map.get($day))   
        #parse($dayPage)
    #end
#end


#** Show next/prev control for specified pager *#
#macro(showNextPrevControl $pager)
    #if ($pager.prevLink)
        &laquo; <a href="$pager.prevLink">$pager.prevName</a> |  
    #end
    #if ($pager.prevLink || $pager.nextLink)
        <a href="$pager.getHomeLink()">$pager.getHomeName()</a>
    #end
    #if ($pager.nextLink)
        | <a href="$pager.nextLink">$pager.nextName</a> &raquo;
    #end
#end


#** 
Show comments for weblog entry according to Roller configuration 
*#
#macro(showWeblogEntryComments $entry)
    #set($commentPreview = $model.getCommentPreview())
    <a name="comments"></a>
    <div class="comments">

    #if($commentPreview)
        #set($comments = [$commentPreview])
        <div class="comments-head">$text.get( "macro.weblog.preview" ):</div>
    #else
        <div class="comments-head">$text.get( "macro.weblog.comments" ):</div>
        #set($entry = $map.getValues().get(0))
        #set($comments = $entry.getComments(true, true))
    #end

    <br/>
    #foreach( $comment in $comments )
        <!-- comment: $comment.id -->
        #if($comment.approved || $commentPreview)
            #set($content = $utils.encodeEmail($comment.content))
            #if($config.getBooleanProperty("users.comments.escapehtml"))
                #set($content = $utils.escapeHTML($content))
            #else 
                #set($content = $utils.transformToHTMLSubset($utils.escapeHTML($content)))
            #end
            #if($config.getBooleanProperty("users.comments.autoformat"))
                #set($content = $utils.autoformat($content))
            #end
            #set($content = $utils.addNofollow($content))

            <div class="comment#if($velocityCount % 2 == 0) even#else odd#end" id="comment${velocityCount}">
                #if ($content.startsWith("<p>")) #set ($content = $content.substring(3)) #end
                <strong>${velocityCount}.</strong> ${content}

                $dateFormatter.applyPattern($text.get( "macro.weblog.datepattern" ))
                <p class="comment-details">
                $text.get("macro.weblog.postedby")
                #if (!$utils.isEmpty($comment.name) && !$utils.isEmpty($comment.remoteHost))
                    <b>$comment.name</b> ($comment.remoteHost)
                #elseif (!$utils.isEmpty($comment.name))
                    <b>$comment.name</b>
                #elseif (!$utils.isEmpty($comment.remoteHost))
                    <b>$comment.remoteHost</b>
                #end
                $text.get("macro.weblog.on") $dateFormatter.format($comment.postTime)
                #if( $utils.isNotEmpty($comment.url) )
                    $text.get( "macro.weblog.postedbywebsite", [$comment.url, $comment.url] )
                #end
                <a href="${ctxPath}${entry.permaLink}#comment${velocityCount}"
                   class="entrypermalink"
                   title="$text.get( "macro.weblog.commentpermalink.title" )">#</a>
                </p>
            </div>

        #end
    #end
    </div>
#end


#** 
Show comments form for weblog entry 
*#
#macro(showWeblogEntryCommentForm $entry)
    #set($cform = $model.getCommentForm())

    <div class="comments-form">
    <div class="comments-head">$text.get("macro.weblog.postcommentHeader")</div>

    #if( $model.errorMessage )
        <span class="error">$model.errorMessage</span>
    #end
    #if( $model.statusMessage )
        <span class="status">$model.statusMessage</span>
    #end

    <form method="post" action="$config.getContextURL()/roller-ui/rendering/comment/$entry.website.handle/entry/$entry.anchor" 
        focus="name" name="form" onsubmit="fixURL(this); return validateComments(this)">    
        <input type="hidden" name="method" value="post" />
        <input type="hidden" name="entryid" value="$entry.id" />

        <ul>
            <li>
                <label class="desc">$text.get( "macro.weblog.name" )</label>
                <input type="text" name="name" class="text large" value="$cform.name" size="50" maxlength="255" />
            </li>


            <li><label class="desc">$text.get( "macro.weblog.email" )</label>
                <input type="text" name="email" class="text large" value="$cform.email" size="50" maxlength="255" />
            </li>

            <li><label class="desc">$text.get( "macro.weblog.url" )</label>
                <input type="text" name="url" class="text large" value="$cform.url" size="50" maxlength="255" />
            </li>

        #if ($config.getBooleanProperty("users.comments.emailnotify"))
            <li><input type="checkbox" class="checkbox" id="notify" name="notify" />
                <label for="notify" class="choice">$text.get( "macro.weblog.notifyMeOfComments" )</label>
            </li>
        #end
            <li>
                <input type="checkbox" class="checkbox" id="rememberInfo" name="rememberInfo" />
                <label for="rememberInfo" class="choice">$text.get( "macro.weblog.rememberinfo" )</label>
            </li>
            <li>
                <label class="desc">$text.get( "macro.weblog.yourcomment" )</label>
                <textarea name="content" class="textarea large" cols="" rows="">$cform.content</textarea>
            </li>
            <li class="info">
                <span class="comments-syntax-indicator">
                $text.get( "macro.weblog.htmlsyntax" )
                #if($config.getBooleanProperty("users.comments.escapehtml"))
                    <span class="disabled">$text.get( "macro.weblog.htmldisabled" )</span>
                #else
                    <span class="enabled">$text.get( "macro.weblog.htmlenabled" )</span>
                #end
                </span>
            </li>
            <li class="info">
               <script type="text/javascript" src="$config.getContextURL()/theme/scripts/clientSideInclude.js"></script>
               <div id="commentAuthenticator"></div>
            </li>
            <li>
               <input type="button" class="button" name="post" value="&nbsp;$text.get( "macro.weblog.preview" )&nbsp;"
                  onclick="this.form.method.value='preview';this.form.submit()" />
               <input type="submit" class="button" name="post" value="&nbsp;$text.get( "macro.weblog.post" )&nbsp;" />
            </li>
        </ul>

    </form>

    <script type="text/javascript" src="$config.getContextURL()/theme/scripts/roller.js"></script>
    <script type="text/javascript">
    clientSideInclude('commentAuthenticator', '$config.getContextURL()/CommentAuthenticatorServlet');

    var author = getCookie("commentAuthor");
    var email = getCookie("commentEmail");
    var url = getCookie("commentUrl");
    // check each field - IE will render "null"
    if (author) {
        document.forms['commentForm'].name.value = author;
    }
    if (email) {
        document.forms['commentForm'].email.value = email;
    }
    if (url) {
        document.forms['commentForm'].url.value = url;
    }

    if (author || email || url) {
        document.forms['commentForm'].rememberInfo.checked = true;
    }

    function fixURL(theForm) {
        if (theForm.url.value != "" &&
            theForm.url.value.indexOf("http://") == -1) { //prepend http://
            theForm.url.value = "http://"+theForm.url.value;
        }
        saveUserInformation(theForm);
    }

    function saveUserInformation(theForm) {
        if (theForm.rememberInfo.checked) {
            rememberUser(theForm);
        } else {
            forgetUser(theForm);
        }
    }

    function validateComments(theForm) {
        if (theForm.content.value == "") {
            alert("$text.get( "macro.weblog.commentwarning" )");
            theForm.content.focus();
            return false;
        }
    }
    </script>
    </div>
#end

#** Show weblog's categories in specified parent category *#
#macro(showCategoryLinksList $weblog $categoryPath)
    #set($rawUrl = "$config.contextURL/$weblog.handle")
    <ul class="clearfix">
        #set($weblogUrl = $rawUrl)
        #set($selectedCat = "")
        #if($model.weblogCategory)
           #set($selectedCat = $model.weblogCategory)
           <li><a href="$weblogUrl">$text.get("macro.weblog.allcategories")</a></li>
        #else
           <li class="selected"><a href="$weblogUrl">$text.get("macro.weblog.allcategories")</a></li>
        #end
        #if($req.getParameter($PAGEID_KEY) )
            #set($pageParam = "&$PAGEID_KEY=$req.getParameter($PAGEID_KEY)")
        #end
        #set($cats = $weblog.getWeblogCategories($categoryPath))
        #foreach($cat in $cats)
            #set($catParam = "?cat=$utilities.encode($cat.path)")
            #set($weblogUrl = "$rawUrl$catParam$!pageParam")
            #if($selectedCat == $cat.path)
                <li class="selected"><a href="$weblogUrl">$cat.name</a></li>
            #else
                <li><a href="$weblogUrl">$cat.name</a></li>
            #end
        #end
    </ul>
#end

#** Show recent weblog entries in specified category *#
#macro(showWeblogEntryLinksList $weblog $categoryPath $max)
   #set($recentEntries = $weblog.getRecentWeblogEntries($categoryPath, $max))
   <ul class="recentposts">
   #foreach ($var in $recentEntries)
       <li class="recentposts"><a href="$var.permalink">$var.title</a></li>
   #end
   </ul>
#end

