
#** Set of essential macros needed in Roller velocity templates.

    #includeTemplate($weblog $pageName)
    #showAutodiscoveryLinks($weblog)
    #showTrackbackAutodiscoveryRDF($entry)
    #showCommonJavascript()

    #showWeblogEntriesPager($pager)
    #showNextPrevControl($pager)

    #showWeblogEntryComments($entry)
    #showWeblogEntryCommentForm($entry)

    #showWeblogEntryLinksList($entries)
    #showBookmarkLinksList($folderObj $expanding $subfolders)
    #showWeblogCategoryLinksList($categoryObj $expanding $subcats)

    #showWeblogEntryCalendar($weblog $category)
    #showPageMenu($weblog)
    #showAuthorMenu($vertical)

Todo:
    #showSearchForm()
    #showSearchAgainForm()
    #showSearchSummary()
    #showSearchPager()
*#


#** 
Parse and include page template from weblog.
*#
#macro(includeTemplate $weblog $pageName)
    #set($iPageId = false)## This is required for such constructs; see Velocity docs and ROL-689
    #set($iPageId = $weblog.findPageIdByName($pageName))
    #if (!$iPageId) ## no page found, parse pageName
        #set($iPageId = $pageName)
    #end
    #parse($iPageId)
#end


#** 
Show RSS, Atom and RSD auto-discovery links as HTML link elements.
*#
#macro(showAutodiscoveryLinks $weblog)
    <link rel="alternate" type="application/atom+xml" title="Atom Entries"  href="$weblog.URL/feeds/entries/atom" />
    <link rel="alternate" type="application/atom+xml" title="Atom Comments" href="$weblog.URL/feeds/comments/atom" />
    <link rel="alternate" type="application/rss+xml"  title="RSS Entries"   href="$weblog.URL/feeds/entries/rss" />
    <link rel="alternate" type="application/rss+xml"  title="RSS Comments"  href="$weblog.URL/feeds/comments/rss" />
    #if ($weblog.enableBloggerApi)
       <link rel="EditURI"   type="application/rsd+xml" title="RSD" href="$weblog.URL/rsd"/>
    #end
#end


#** 
Show trackback discovery code for one weblog entry, appears as an HTML comment.
*#
#macro(showTrackbackAutodiscoveryRDF $entry)
<!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/"
         xmlns:dc="http://purl.org/dc/elements/1.1/">
<rdf:Description
    rdf:about="$entry.permalink"
    trackback:ping="$entry.trackbackURL"
    dc:title="$entry.title"
    dc:identifier="$entry.permalink"
    dc:subject="$entry.category.name"
    dc:description="$entry.title"
    dc:creator="$entry.creator.userName"
    dc:date="$entry.pubTime" />
</rdf:RDF>
-->
#end


#**
Include Javascript code needed for standard macros, for use in HTML head.
*#
#macro(showCommonJavascript)
<script type="text/javascript" src="$config.getContextURL()/theme/scripts/roller.js"></script>
#end


#** 
Shows weblog entries pager via default day template 
*#
#macro(showWeblogEntriesPager $pager)
    #set($dayPage = $model.weblog.findPageIdByName("_day"))
    #set($map = $pager.getEntries())
    #foreach($day in $map.keySet())
        #set($entries = $map.get($day))   
        #parse($dayPage)
    #end
#end


#** Show next/prev control for specified pager *#
#macro(showNextPrevControl $pager)
    #set($prevLink = false)
    #set($nextLink = false)
    #if ($pager.prevLink)
        #set($prevLink = $pager.prevLink)
        #set($prevName = $pager.prevName)
    #elseif ($pager.prevCollectionLink)
        #set($prevLink = $pager.prevCollectionLink)
        #set($prevName = $pager.prevCollectionName)
    #end
    #if ($pager.nextLink)
        #set($nextLink = $pager.nextLink)
        #set($nextName = $pager.nextName)
    #elseif ($pager.nextCollectionLink)
        #set($nextLink = $pager.nextCollectionLink)
        #set($nextName = $pager.nextCollectionName)
    #end
    #if ($prevLink)
        &laquo; <a href="$prevLink">$prevName</a> |  
    #end
    #if ($prevLink || $nextLink)
        <a href="$pager.getHomeLink()">$pager.getHomeName()</a>
    #end
    #if ($nextLink)
        | <a href="$nextLink">$nextName</a> &raquo;
    #end
#end


#** 
Show comments for weblog entry according to Roller configuration.
*#
#macro(showWeblogEntryComments $entry)
    #set($commentPreview = $model.getCommentPreview())
    <a name="comments"></a>
    <div class="comments">

    #if($commentPreview)
        #set($comments = [$commentPreview])
        <div class="comments-head">$text.get( "macro.weblog.preview" ):</div>
    #else
        <div class="comments-head">$text.get( "macro.weblog.comments" ):</div>
        #set($entry = $map.getValues().get(0))
        #set($comments = $entry.getComments(true, true))
    #end

    <br/>
    #foreach( $comment in $comments )
        <!-- comment: $comment.id -->
        #if($comment.approved || $commentPreview)
            #set($content = $utils.encodeEmail($comment.content))
            #if($config.getBooleanProperty("users.comments.escapehtml"))
                #set($content = $utils.escapeHTML($content))
            #else 
                #set($content = $utils.transformToHTMLSubset($utils.escapeHTML($content)))
            #end
            #if($config.getBooleanProperty("users.comments.autoformat"))
                #set($content = $utils.autoformat($content))
            #end
            #set($content = $utils.addNofollow($content))

            <div class="comment#if($velocityCount % 2 == 0) even#else odd#end" id="comment${velocityCount}">
                #if ($content.startsWith("<p>")) #set ($content = $content.substring(3)) #end
                <strong>${velocityCount}.</strong> ${content}

                $dateFormatter.applyPattern($text.get( "macro.weblog.datepattern" ))
                <p class="comment-details">
                $text.get("macro.weblog.postedby")
                #if (!$utils.isEmpty($comment.name) && !$utils.isEmpty($comment.remoteHost))
                    <b>$comment.name</b> ($comment.remoteHost)
                #elseif (!$utils.isEmpty($comment.name))
                    <b>$comment.name</b>
                #elseif (!$utils.isEmpty($comment.remoteHost))
                    <b>$comment.remoteHost</b>
                #end
                $text.get("macro.weblog.on") $dateFormatter.format($comment.postTime)
                #if( $utils.isNotEmpty($comment.url) )
                    $text.get( "macro.weblog.postedbywebsite", [$comment.url, $comment.url] )
                #end
                <a href="${ctxPath}${entry.permaLink}#comment${velocityCount}"
                   class="entrypermalink"
                   title="$text.get( "macro.weblog.commentpermalink.title" )">#</a>
                </p>
            </div>

        #end
    #end
    </div>
#end


#** 
Show comments form for weblog entry. 
*#
#macro(showWeblogEntryCommentForm $entry)
    #set($cform = $model.getCommentForm())

    <div class="comments-form">
    <div class="comments-head">$text.get("macro.weblog.postcommentHeader")</div>

    #if( $model.errorMessage )
        <span class="error">$model.errorMessage</span>
    #end
    #if( $model.statusMessage )
        <span class="status">$model.statusMessage</span>
    #end

    <form method="post" action="$config.getContextURL()/roller-ui/rendering/comment/$entry.website.handle/entry/$entry.anchor" 
        focus="name" name="form" onsubmit="fixURL(this); return validateComments(this)">    
        <input type="hidden" name="method" value="post" />
        <input type="hidden" name="entryid" value="$entry.id" />

        <ul>
            <li>
                <label class="desc">$text.get( "macro.weblog.name" )</label>
                <input type="text" name="name" class="text large" value="$cform.name" size="50" maxlength="255" />
            </li>


            <li><label class="desc">$text.get( "macro.weblog.email" )</label>
                <input type="text" name="email" class="text large" value="$cform.email" size="50" maxlength="255" />
            </li>

            <li><label class="desc">$text.get( "macro.weblog.url" )</label>
                <input type="text" name="url" class="text large" value="$cform.url" size="50" maxlength="255" />
            </li>

        #if ($config.getBooleanProperty("users.comments.emailnotify"))
            <li><input type="checkbox" class="checkbox" id="notify" name="notify" />
                <label for="notify" class="choice">$text.get( "macro.weblog.notifyMeOfComments" )</label>
            </li>
        #end
            <li>
                <input type="checkbox" class="checkbox" id="rememberInfo" name="rememberInfo" />
                <label for="rememberInfo" class="choice">$text.get( "macro.weblog.rememberinfo" )</label>
            </li>
            <li>
                <label class="desc">$text.get( "macro.weblog.yourcomment" )</label>
                <textarea name="content" class="textarea large" cols="" rows="">$cform.content</textarea>
            </li>
            <li class="info">
                <span class="comments-syntax-indicator">
                $text.get( "macro.weblog.htmlsyntax" )
                #if($config.getBooleanProperty("users.comments.escapehtml"))
                    <span class="disabled">$text.get( "macro.weblog.htmldisabled" )</span>
                #else
                    <span class="enabled">$text.get( "macro.weblog.htmlenabled" )</span>
                #end
                </span>
            </li>
            <li class="info">
               <script type="text/javascript" src="$config.getContextURL()/theme/scripts/clientSideInclude.js"></script>
               <div id="commentAuthenticator"></div>
            </li>
            <li>
               <input type="button" class="button" name="post" value="&nbsp;$text.get( "macro.weblog.preview" )&nbsp;"
                  onclick="this.form.method.value='preview';this.form.submit()" />
               <input type="submit" class="button" name="post" value="&nbsp;$text.get( "macro.weblog.post" )&nbsp;" />
            </li>
        </ul>

    </form>

    <script type="text/javascript" src="$config.getContextURL()/theme/scripts/roller.js"></script>
    <script type="text/javascript">
    clientSideInclude('commentAuthenticator', '$config.getContextURL()/CommentAuthenticatorServlet');

    var author = getCookie("commentAuthor");
    var email = getCookie("commentEmail");
    var url = getCookie("commentUrl");
    // check each field - IE will render "null"
    if (author) {
        document.forms['commentForm'].name.value = author;
    }
    if (email) {
        document.forms['commentForm'].email.value = email;
    }
    if (url) {
        document.forms['commentForm'].url.value = url;
    }

    if (author || email || url) {
        document.forms['commentForm'].rememberInfo.checked = true;
    }

    function fixURL(theForm) {
        if (theForm.url.value != "" &&
            theForm.url.value.indexOf("http://") == -1) { //prepend http://
            theForm.url.value = "http://"+theForm.url.value;
        }
        saveUserInformation(theForm);
    }

    function saveUserInformation(theForm) {
        if (theForm.rememberInfo.checked) {
            rememberUser(theForm);
        } else {
            forgetUser(theForm);
        }
    }

    function validateComments(theForm) {
        if (theForm.content.value == "") {
            alert("$text.get( "macro.weblog.commentwarning" )");
            theForm.content.focus();
            return false;
        }
    }
    </script>
    </div>
#end


#** 
Show recent weblog entries in specified category. 
*#
#macro(showWeblogEntryLinksList $entriesList)
   <ul class="entriesList">
   #foreach ($var in $entriesList)
       <li class="recentposts"><a href="$var.permalink">$var.title</a></li>
   #end
   </ul>
#end


#** 
Show bookmarks as a HTML ul list.
*#
#macro(showBookmarkLinksList $folderObject $subfolders $expanding )
<ul class="rFolder">
#_showBookmarkLinksList($folderObject $subfolders $expanding)
</ul>
#end


#** 
Show bookmarks as a HTML ul list (private).
*#
#macro(_showBookmarkLinksList $folderObject $subfolders $expanding )
    #set($bookmarks = $folderObject.getBookmarks())
    #set($folders = $folderObject.getFolders())
    #set($divId = $utils.replace($folderObject.name, " ", "_" ))
    #if ($folderObject.name != "root" && $expanding && $subfolders && ($folderObject.getBookmarks().size() > 0 || $folderObject.getFolders().size() > 0))
        <div class="rFolder">
        <li class="rFolderItem"><a href="javascript:toggleFolder('$divId')">
            <span id="i$divId">+</span></a>$folderObject.Name</li>
        <ul id="$divId" class="rFolder" style="display:none">
    #elseif ($folderObject.name != "root" && $subfolders && ($folderObject.getBookmarks().size() > 0 || $folderObject.getFolders().size() > 0))
        <li class="rFolderItem">$folderObject.Name</li>
        <ul class="rFolder">
    #elseif ($folderObject.name != "root")
        <li class="rFolderItem">$folderObject.Name</li>
    #end
    #foreach($bookmark in $bookmarks)
        <li class="rFolderItem">
        #if($utils.isNotEmpty($bookmark.Image))
          #if( $bookmark.Image.startsWith("http://") )
          <a href="$bookmark.url">
             <img alt="$bookmark.description" border="0"
                src="$bookmark.image" class="rBookmark" /></a>
          #else
          <a href="$bookmark.url">
             <img alt="$bookmark.description" border="0"
                src="$bookmark.image" class="rBookmark" /></a>
          #end
        #else
            #if($utils.isNotEmpty( $bookmark.FeedUrl))
            <a href="$bookmark.feedUrl"><img class="smrssbadge"
               src="$config.getAbsoluteContextURL()/images/smrssbadge.gif"
               alt="$text.get("macro.bookmark.urlFeed")"/></a>
            #end
            <a href="$bookmark.url"
               title="$bookmark.description"
               class="rBookmark$bookmark.weight">$bookmark.name</a>
        #end
        </li>
    #end
    ## show sub-folders
    #if ($subfolders)
        #foreach($sFolder in $folders)
            #_showBookmarkLinksList($sFolder $subfolders $expanding )
        #end
    #end
    #if ($folderObject.name != "root" && $subfolders && ($folderObject.getBookmarks().size() > 0 || $folderObject.getFolders().size() > 0))
        </ul>
    #end
    #if ($folderObject.name != "root" && $expanding && $subfolders && ($folderObject.getBookmarks().size() > 0 || $folderObject.getFolders().size() > 0))
        </div>
        <script type="text/javascript">
        <!-- 
        folderPreference("$divId");
        // -->
        </script>
    #end
#end


#** 
Show weblog's categories in specified parent category.
*#
#macro(showWeblogCategoryLinksList $categoryObject $subcats $expanding )
    #if(!$expanding && !$subcats)
        <ul class="rCategory">
        #if ($model.weblogCategory)
           <li><a href="$categoryObject.website.URL">$text.get("macro.weblog.allcategories")</a></li>
        #else
           <li class="selected">$text.get("macro.weblog.allcategories")</li>
        #end
        #set($cats = $categoryObject.getWeblogCategories())
        #foreach($cat in $cats)
            #set($catParam = "?cat=$utilities.encode($cat.path)")
            #set($catURL = "$cat.website.URL$catParam")
            #if($model.weblogCategory && $model.weblogCategory.path == $cat.path)
                <li class="selected"><a href="$categoryObject.website.URL/category$cat.path">$cat.name</a></li>
            #else
                <li><a href="$categoryObject.website.URL/category$cat.path">$cat.name</a></li>
            #end
        #end
        </ul>
    #else
        <ul class="rCategory">
        #_showWeblogCategoryLinksList($categoryObject $subcats $expanding )
        </ul>
    #end
#end


#**
*#
#macro(_showWeblogCategoryLinksList $categoryObject $subcats $expanding )
    #set($catParam = "?cat=$utils.encode($categoryObject.path)")
    #set($catURL = "$categoryObject.website.URL$catParam")
    #if ($categoryObject.name != "root")
        #if ($expanding && $subcats && $categoryObject.weblogCategories.size() > 0)
            #set($divId = "div_$categoryObject.name")
            <div class="rCategory">
            <li><a href="javascript:toggleFolder('$divId')">
                <span id="i$divId">+</span></a><a href="$catURL">$categoryObject.name</a></li>
            <ul id="$divId" class="rCategory" style="display:none">
        #elseif ($subcats && $categoryObject.weblogCategories.size() > 0)
            <li><a href="$catURL">$categoryObject.name</a></li>
            <ul class="rCategory">
        #else
            #if ($model.weblogCategory && $model.weblogCategory.path == $categoryObject.path)
                <li class="selected"><a href="$catURL">categoryObject.name</a></li>
            #else
                <li><a href="$catURL">$categoryObject.name</a></li>
            #end
        #end
    #end
    #if ($subcats || $categoryObject.name == "root") 
        #set($cats = $categoryObject.getWeblogCategories())
        #foreach($cat in $cats)
            #_showWeblogCategoryLinksList($cat $subcats $expanding)
        #end
    #end
    #if ($categoryObject.name != "root" && $subcats && $categoryObject.weblogCategories.size() > 0)
        </ul>
    #end
    #if ($expanding && $subcats && $categoryObject.weblogCategories.size() > 0)
    </div>
    <script type="text/javascript">
    <!-- 
    folderPreference("$divId");
    // -->
    </script>
    #end
#end


#**
 * Show Roller Page Navigation Bar, includes links to all pages.
 *#
#macro(showPageMenu $weblog)
    <ul class="rNavigationBar">
        <li class="rNavItem">
            <a href="$config.getContextURL()">$config.getProperty("site.shortName")</a>
        </li>
        #foreach($iPage in $weblog.pages)
            #set($invisible = $iPage.Name.startsWith("_"))
            #if (!$invisible)
                #set($isSelected = false)
                #if ($page && $iPage.Id == $page.Id) #set($isSelected = true) #end
                #if (!$isSelected && $iPage.name == "Weblog")
                    <li class="rNavItem"><a href="$weblog.URL">$iPage.name</a></li>
                #elseif (!$isSelected)
                    <li class="rNavItem"><a href="$weblog.URL/page/$iPage.link">$iPage.name</a></li>
                #else
                    <li class="rNavItem">$iPage.name</li>
                #end
            #end
        #end
        #if ($utils.isUserAuthorizedToAuthor($weblog))
            <li class="rNavItem">
               <a href="$config.getWeblogEntryCreateURL($weblog)">$text.get("navigationBar.newEntry")</a>
            </li>
            #if($utils.isUserAuthorizedToAdmin($weblog))
               <li class="rNavItem">
                   <a href="$config.getWeblogSettingsURL($weblog)">$text.get("navigationBar.settings")</a>
               </li>
            #end
                <li class="rNavItem">
                    <a href="$config.getLogoutURL()">$text.get("navigationBar.logout")</a>
                </li>
        #else
            #if ($utils.isUserAuthenticated())
                <li class="rNavItem">
                    <a href="$config.getLogoutURL()">$text.get("navigationBar.logout")</a>
                </li>
            #else
                <li class="rNavItem">
                    <a href="$config.getLoginURL()">$text.get("navigationBar.login")</a>
                </li>
            #end
        #end
    </ul>
#end


#** 
Show weblog entry calendar, with optional category restriction.
*#
#macro(showWeblogEntryCalendar $weblog $category)
$calendarModel.showWeblogEntryCalendar($weblog, $category)
#end


#** 
Show weblog author menu with vertical or horizontal orientation.
*#
#macro(showAuthorMenu $vertical)
$menuModel.showAuthorMenu($vertical)
#end


#** 
    TODO 3.0
*#
#macro(showSearchForm $weblog)
$weblog
#end


#** 
    TODO 3.0
*#
#macro(showSearchAgainForm $weblog)
$weblog
#end


#** 
    TODO 3.0
*#
#macro(showSearchSummary $weblog)
$weblog
#end


#** 
    TODO 3.0
*#
#macro(showSearchPager $pager)
$pager
#end


