<!--
Builds standalone Roller demo with Tomcat, HSQLDB, and integrated JSPWiki.
Makes the following assumptions:
   * Roller has been built to ${roller.srcdir}/build/roller
   * Roller tests have been built into ${roller.srcdir}/build/tests
   * Tomcat and JSPWiki have been downloaded:
     - Tomcat gzipped tar file in in ./components directory
     - JSPWiki zip file in ./components directory
   * The Hibernate configuration file in ./tomcat is up-to-date
-->
<project name="roller_demo" default="roller_demo">

<!--
You must download Tomcat and JSPWiki yourself and ensure that the three 
properties below point to the downloaded files.
-->
<property name="tomcat.filename" value="./components/jakarta-tomcat-5.0.28.tar.gz" />	
<property name="tomcat.basename" value="jakarta-tomcat-5.0.28" />	
<property name="jspwiki.filename" value="./components/jspwiki-2.2.33-bin.zip" />

<property name="roller.srcdir" value="../.." />

<target name="roller_demo" depends="create_bundle" >
</target>

<target name="plugins"
    description="Build HSQLDB startup listener and JSPWiki page provider">

    <mkdir dir="./build/classes" />
    <javac debug="${build.debug}" srcdir="./src" destdir="./build/classes" >
        <classpath>
            <fileset dir="./lib">
                <include name="*.jar" />
            </fileset>
            <fileset dir="${roller.srcdir}/contrib/lib">
                <include name="JSPWiki.jar" />
            </fileset>
            <fileset dir="${roller.srcdir}/tools/buildtime">
                <include name="hsqldb.jar" />
            </fileset>
        </classpath>
    </javac>   	
    <jar destfile="./build/roller-hsqldb.jar" 
        basedir="./build/classes" 
        excludes="org/roller/jspwiki/**" />
    <jar destfile="./build/roller-jspwiki.jar"
        basedir="./build/classes" 
        includes="org/roller/jspwiki/**" />
</target>

<target name="create_bundle" depends="plugins"
   description="Copy in Tomcat, JSPWiki, Roller, and plugin jars">

   <!-- untar Tomcat, put it in ./build/roller-demo -->
   <untar src="${tomcat.filename}" dest="./build" compression="gzip" />
   <rename src="./build/${tomcat.basename}" dest="./build/roller-demo" />
	
   <delete dir="./build/roller-demo/webapps/tomcat-docs" />
   <delete dir="./build/roller-demo/webapps/servlets-examples" />
   <delete dir="./build/roller-demo/webapps/jsp-examples" />
   <delete dir="./build/roller-demo/webapps/webdav" />

   <!-- unzip JSPWiki, unjar its WAR into ./build/roller-demo/webapps -->
   <mkdir  dir="./build/roller-demo/webapps/wiki" />
   <unzip  src="${jspwiki.filename}" dest="./build" />
   <unjar  src="./build/JSPWiki/JSPWiki.war" 
          dest="./build/roller-demo/webapps/wiki" />
   
   <!-- Roller wiki plugin goes in JSPWiki webapp -->
   <copy file="./build/roller-jspwiki.jar" 
        todir="./build/roller-demo/webapps/wiki/WEB-INF/lib" />

   <!-- Copy Roller from its build directory -->       
   <mkdir dir="./build/roller-demo/webapps/roller" />
   <copy todir="./build/roller-demo/webapps/roller" >
       <fileset dir="${roller.srcdir}/build/roller" includes="**/**" />
   </copy>
   	   
   <!-- Roller HSQLDB starter goes into Tomcat -->
   <copy file="./build/roller-hsqldb.jar" 
        todir="./build/roller-demo/server/lib" />
   <copy file="${roller.srcdir}/tools/buildtime/hsqldb.jar" 
        todir="./build/roller-demo/common/lib" />
   <copy file="${roller.srcdir}/tools/lib/mail.jar" 
        todir="./build/roller-demo/common/lib" />
   <copy file="${roller.srcdir}/tools/lib/activation.jar" 
        todir="./build/roller-demo/common/lib" />
	
   <!-- Copy copy-over files for Tomcat -->
   <copy todir="./build/roller-demo" overwrite="true">
       <fileset dir="./tomcat" includes="**/**" />
   </copy>
   <copy todir="./build/roller-demo" overwrite="true" failonerror="false">
       <fileset dir="./custom" includes="**/**" />
   </copy>
        
   <!-- Copy copy-over files for JSPWiki -->
   <copy todir="./build/roller-demo/webapps/wiki" overwrite="true">
       <fileset dir="./jspwiki" includes="**/**" />
   </copy>
	        
   <chmod perm="+x">
       <fileset dir="./build/roller-demo/bin" includes="*.sh" />
   </chmod>
    
</target>
	
<target name="init_database" depends="create_bundle"
	description="Create fresh new Roller database in the bundle" >

	<!-- assumes that build/roller-demo/blogdata/ directory is empty -->
	
    <!-- Start HSQLDB with Roller's custom startdb task -->
    <taskdef name="startdb" classname="org.roller.ant.StartHsqldbTask" 
        classpath="./build/roller-demo/common/lib/hsqldb.jar;${roller.srcdir}/build/tests/WEB-INF/classes" />
    <taskdef name="stopdb" classname="org.roller.ant.StopHsqldbTask" 
        classpath="./build/roller-demo/common/lib/hsqldb.jar;${roller.srcdir}/build/tests/WEB-INF/classes" />
    <startdb database="./build/roller-demo/blogdata/rollerdb" port="3219" />
        
    <!-- Create standard Roller database tables -->
    <sql driver="org.hsqldb.jdbcDriver"
        url="jdbc:hsqldb:hsql://localhost:3219"
        userid="sa" password=""
        src="./build/roller-demo/webapps/roller/WEB-INF/dbscripts/hsql/createdb.sql"
        classpath="./build/roller-demo/common/lib/hsqldb.jar" />
        
    <!-- Shutdown HSQLDB --> 
    <stopdb port="3219"/>
    
</target>

<target name="clean">
    <delete dir="build" />
</target>

</project>




